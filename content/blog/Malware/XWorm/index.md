---
title: XWorm
date: 2025-04-21
draft: false
author: Kyd1ct
description: A static and dynamic analysis of a RAT.
---

{{< alert icon="circle-info" cardColor="#5D3FD3" iconColor="#21286b" textColor="#f1faee" >}}
Note: The analysis is still ongoing and the page is under construction.
{{< /alert >}}

In this article, weâ€™ll break down how this version of XWorm works, including:

- Static Analysis: Attempting to deobfuscate the batch script to understand how it works.

- Dynamic Analysis: Running XWorm in a test environment to see what it tries to do on the system..


## Discovery
The malicious script was obtained through the popular threat hunting community [AbuseCH](https://abuse.ch/) and their malware sample sharing platform [Malware Bazaar](https://bazaar.abuse.ch/). Credit to [smica83](https://bazaar.abuse.ch/user/5160/) for sharing the sample.

![Initial Discovery](/img/Malware/XWorm/discovery.jpg)

I first checked the website in [VirusTotal](https://www.virustotal.com/gui/file/e5269c1e1058ff5344999040ab4d02ad3cc2cb1020a2e1d9de9c62fed5e9123f)  and saw that the script was marked as malicious by multiple vendors. The first submisison occurred on the 18th of April, 2025, which indicated a new version of the RAT. The sample was also known as `04cb.bat` and `fwgwng.bat`.


## Analysis
### Static Analysis

When I opened the batch script I noticed that it was heavily obfuscated. At first I was confused but then I noticed a pattern - there were random strings encased with `%` and in-between them there were single characters that made up actual strings. After further research I found an article from [Huntress](https://www.huntress.com/blog/tried-and-true-hacker-technique-dos-obfuscation) - this is a common obfuscation technique used by attacks for batch scripts called **DOS Obfuscation**.

I decided to dump the contents of the batch script within CyberChef and I used RegEx to deobfuscate the script. I first tested the regular expression (`%[a-zA-Z0-9]+([^\s%])[a-zA-Z0-9]+%`), then removed the DOS Obfuscation:

![RegEx Test](/img/Malware/Xworm/regex_test.png)

![DOS Obfuscation Cleanup](/img/Malware/Xworm/initial_cleanup.png)

Afterwards I removed the long variable and replaced it with `set` (Refer to the image within the Discovery section.)

![Replacing the long variable.](/img/Malware/Xworm/second_cleanup.png)

After the inital cleanup, the batch script contained some identifiable commands, a long string that appeared to be commented out (`::`), a base64 string, and a lot of variables that contained chunks of clear and base64 encoded text in random order.

Starting off with the identifiable commands, we can see the following:

![Replacing the long variable.](/img/Malware/Xworm/start.jpg)

The script first disables command echoing and launched the commandline in a minimized window, specifying the full path of the script (drive, path, name, extension - `%~dpnx0`). It then exits the initial script and continues only with the new, minimized instance. Afterwards, a sourceFile variable is set, assigning the current pathdrive, path, name, and extension of the script. 

The next command (`copy "" "\dwm.bat" >nul"`) appears to be malformed. It is possible that this was done with the intention to confuse the analyst. The copy command requires both source and destination, in this case the source being an empty string. This invalidates the command. The output is also suppressed with `>nul`. Finally, the script enables delayed variable exansion ([`setlocal enabledelayedexpansion`](https://ss64.com/nt/delayedexpansion.html)) - this will allow the variables within the batch script to change throughout the execution and are not fixed at parse time.

Afterwards, the script assigns Base64 chunks to randomly named variables in a randomised order. This will be skipped for now.

A long comment follows the first few random variables, but I was unable to decode/decrypt it. It is possible that the complete base64 string from the variables may have hints regarding this so this will be revisited afterwards.

A lot more randomised variables follow before we reach a line that looks like this:

![Base64 label.](/img/Malware/Xworm/base64.jpg)

This is clearly a Base64 string which we can decode. Before we do this, however, we can see something interesting - the use of `:::`. What would that do? In Batch scripts `:` is a lable and `::` is a comment. Triple colon does not exist in Batch so this is most likely a lable with the Base64 string as a comment. It is possible that the reconstructed command from the random variables could lead to this comment and extract the command. 

The Base64 command has a script that defines a main function (`Start-GenProcess`) which takes two optional parameters `$EnableVerbose` and `$DisableService`. The script assigns commands to variables. They are encoded to bypass detection. The entire script was obfuscated as a whole, using variables to concatenate strings and bypass detection/make analysis slower.

![Hex Encoding.](/img/Malware/Xworm/hex.jpg)

As a whole, the script can do the following:
- Retrieve address of `GetProcAddress`, `GetModuleHandle` from user32.dll
- Retrieve address of AmsiInitialize function in amsi.dll
- Initialise Amsi and modify memory protection - `0xb8,0x0,0x00,0x00,0x00,0xC3` - `mov eax, 0; ret`

Similar [versions](https://fluidattacks.com/blog/amsi-bypass/) of this specific assemby have been used to bypass Amsi. In this case it is passing `0x0`, which is a [standardised error code](https://learn.microsoft.com/en-us/windows/win32/learnwin32/error-handling-in-com) (`S_OK`) in COM.

The script also disables `EtwEventWrite`. Combining this with the `VirtualProtect` and the previously mentioned capabilities, it allows the script to patch system files while evading security mechanisms and disabling logging. Finally it checks if the `$DisableService` flag is set, indicating that service manipulation was successful.

![End of script.](/img/Malware/Xworm/disable_srv.jpg)


###  Conclusion
{{< alert icon="circle-info" cardColor="#5D3FD3" iconColor="#21286b" textColor="#f1faee" >}}
Note: Analysis still ongoing.
{{< /alert >}}

## IoCs  

### Hashes
MD5: 258e7f6f287106dda8c97422a776e823
SHA256: e5269c1e1058ff5344999040ab4d02ad3cc2cb1020a2e1d9de9c62fed5e9123f 